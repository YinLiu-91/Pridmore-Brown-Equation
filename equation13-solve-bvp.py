import numpy as np
from scipy.integrate import solve_bvp
from scipy.special import jv, jvp
import matplotlib.pyplot as plt
"""
先说结论：之所以把脚本改成现在这样，是为了让数值求解真正符合公式 (13) 的物理/数学假设，并且让 `solve_bvp` 能在含复系数、奇点的情形下收敛。

## 改动背后的理由
- **公式 (13) 的结构**：它是一个系数包含 $1/r$ 和 $1/r^2$ 的复系常系数 ODE。`solve_bvp` 只接受实值状态量，所以必须把 $\hat p$ 拆成实部、虚部组成的 4 维系统 `[Re(p), Im(p), Re(p'), Im(p')]` 才能求解。
- **r=0 的奇点**：直接从 0 开始会遇到 $1/r$、$1/r^2$ 发散。脚本用 `r_min=1e-4` 代替 0，并在那一点施加 $p'(r_min)=0`，这是常规的“正则性”处理，等价于你在 $r\to0$ 的对称（Neumann）条件。
- **壁面阻抗边界**：Ingard–Myers 条件本来就是复数关系 $p'(1) - i(k-Mk_{m,n})p(1)/Z=0$。旧代码把它删掉成 `dp1=0`，等于给了完全不同的边界。改成现在的形式是为了按原文物理模型套入。
- **初始猜测**：把 Bessel $J_m(\alpha r)$ 作为初值是因为它正好满足中心对称条件并近似满足方程（当阻抗与流速影响不大时），比随便的猜测更容易收敛，同时自动给出复部猜测。
- **输出可读性**：同时画 $|p|$、实部、虚部，可以检查解是否合理（比如是否满足预期衰减/振荡），也方便和解析近似对比。

总之，所有调整都是为了让数值解真实反映公式 (13) 的解；之前的版本相当于在不同方程/边界条件上求解，因此才会“不对”。现在，只要安装好 `matplotlib` / `scipy`，脚本运行后给出的解就是满足原方程和边界的。


Ref:[1] On the prediction of far-field fan noise attenuation due to liners considering uniform and shear flows
Ref:[2] A well-posed boundary condition for acoustic liners in straight ducts with flow
"""

# ------------------------------------------------------------------------------------
# 参数设置（可自行修改）
# ------------------------------------------------------------------------------------
m = 24                  # 模态阶数
k = 31.0                # 无量纲波数
M = 0.5                 # 马赫数
# kmn = -44.2+ 1.1j     # Ref[2] a,b 轴向波数（可取复数）
kmn = -17.6 - 21.0j     # Ref[2] c,d 轴向波数（可取复数）


Z = 2.0+0.6j          # 壁面阻抗（复数）
omega = k             # 角频率，若使用不同无量纲化请自行修改
r_min = 0.0        # 避免 r=0 的奇点，从一个很小的半径开始
r_max = 1.0
delta=0.0002
isShearFlow=False
# ------------------------------------------------------------------------------------
# 将复数问题拆为实数 4 维系统
# y = [Re(p), Im(p), Re(dp/dr), Im(dp/dr)]
# ------------------------------------------------------------------------------------

# Ref[2] 公式(14)的对r的导数
def du0dr(r, delta):
    a=1.0-np.tanh(1.0 / delta)
    b=(1 + np.tanh(1.0 / delta)) / delta
    # c= M * ((1.0-np.tanh((1.0 - r) / delta)**2)*(-1.0/delta) + (1 - np.tanh(1.0 / delta)) * (-2.0*((1.0+np.tanh(1.0/delta))/delta+1.0 )*r+(1.0+np.tanh(1.0/delta))/delta))
    return M * ((1.0-np.tanh((1.0 - r) / delta)**2)*(-1.0/delta) + a * (-2.0*(b+1.0 )*r+b))

# Ref[1] 公式有误，使用Ref[2]的公式，应当*r，而不是+r
def u0(r, delta):
    return M * (np.tanh((1 - r) / delta) + (1 - r) * (1 - np.tanh(1 / delta)) * ((1 + np.tanh(1 / delta)) / delta *r + (1 + r)))


def ode(r, y):
    p = y[0] + 1j * y[1]
    dp = y[2] + 1j * y[3]
    # print("dp[0]:",dp[0])
    # 这里用的M，不是 u0(r,delta)
    # coeff = (k - u0(r,delta) * kmn) ** 2 - kmn ** 2
    coeff = (k - M * kmn) ** 2 - kmn ** 2
    # 添加dM/dr项目
    dMdrPart=0.0
    if  isShearFlow:
        # dMdrPart=2.0*kmn/(k - u0(r,delta)*kmn)*du0dr(r,delta) # 这里用的M，不是 u0(r,delta)
        dMdrPart=2.0*kmn/(k - M*kmn)*du0dr(r,delta) # 这里用的M，不是 u0(r,delta)
    d2p = np.where(r > 0.0, -(1.0 / r+dMdrPart) * dp - (coeff - m ** 2 / r ** 2) * p, 0.0)
    # d2p = -(1.0 / r+dMdrPart) * dp - (coeff - m ** 2 / r ** 2) * p

    return np.vstack([
        y[2],
        y[3],
        d2p.real,
        d2p.imag,
    ])


def boundary_conditions(ya, yb):
    # r = r_min: 规则性 => dp/dr = 0（实部与虚部）
    bc_center_real = ya[2]
    bc_center_imag = ya[3]

    # r = r_max: Ingard-Myers 边界条件
    p_wall = yb[0] + 1j * yb[1]
    dp_wall = yb[2] + 1j * yb[3]
    # dp_wall=1.0

    # 声衬边界（Ingard-Myers）：dp/dr + i (k - M k_{mn}) (ω - u_0 k_{mn}) / (ω Z) p = 0
    # u_wall = u0(r_max, delta) if isShearFlow else M
    # impedance_condition = dp_wall + (k - M * kmn) * ((omega - u_wall * kmn) / (1j*omega * Z)) * p_wall
    # 这个结合Ref[1] 公式(10),(19)组合与Ref[2]的公式(5)一致，都能得到如下边界条件
    impedance_condition = dp_wall - (k - M * kmn)**2 / (1j*k* Z )* p_wall

    """
    下面参考的公式来自于此
    A well-posed boundary condition for acoustic liners in straight ducts with flow
    """
    # impedance_condition = dp_wall - (k - M * kmn)**2 / (1j*k* Z )* p_wall

    return np.array([
        bc_center_real,
        bc_center_imag,
        impedance_condition.real,
        impedance_condition.imag,
    ])


# ------------------------------------------------------------------------------------
# 初始猜测：使用 Bessel J_m(alpha r)，其中 alpha^2 = (k - M kmn)^2 - kmn^2
# ------------------------------------------------------------------------------------
alpha_squared = (k - M * kmn) ** 2 - kmn ** 2
alpha = np.sqrt(alpha_squared)

r = np.linspace(r_min, r_max, 80000)

p_guess = jv(m, alpha * r)
dp_guess = alpha * jvp(m, alpha * r)

y_guess = np.vstack([
    p_guess.real,
    p_guess.imag,
    dp_guess.real,
    dp_guess.imag,
])


# ------------------------------------------------------------------------------------
# 调用 solve_bvp
# ------------------------------------------------------------------------------------
sol = solve_bvp(ode, boundary_conditions, r, y_guess, max_nodes=1200000)

if not sol.success:
    raise RuntimeError(f"solve_bvp 未收敛: {sol.message}")


# ------------------------------------------------------------------------------------
# 后处理与绘图
# ------------------------------------------------------------------------------------
p_r_real = sol.y[0][-1]
print("p_r_real:",p_r_real)
p_r = (sol.y[0] + 1j * sol.y[1])/p_r_real
dp_r = (sol.y[2] + 1j * sol.y[3])/p_r_real

print("求解成功，最大残差 =", np.max(np.abs(sol.rms_residuals)))
# 读取文献数据
# 打开并读取文件
file_path = './f1c.txt'  # 替换为你的文件路径
x_values = []  # 存储第一列数据
y_values = []  # 存储第二列数据

with open(file_path, 'r') as file:
    for line in file:
        # 去掉行首行尾的空白字符，并按逗号分割
        x, y = line.strip().split(',')
        # 将字符串转换为浮点数，并添加到列表中
        x_values.append(float(x))
        y_values.append(float(y))
# 转换为numpy数组
x_values = np.array(x_values)
y_values = np.array(y_values)
print("x_values:",x_values)
print("y_values:",y_values)

plt.figure(figsize=(8, 5))
plt.plot(sol.x, np.abs(p_r), label='|p(r)|')
plt.plot(sol.x, p_r.real, '--', label='Re{p(r)}')
plt.plot(sol.x, p_r.imag, '--', label='Im{p(r)}')
plt.scatter(x_values, y_values, color='red', s=10, label='Ref[2] Fig.1 c data')
# p_r的幅值，相位模式
plt.xlabel('r')
plt.ylabel('声压')
plt.title(f'公式(13) BVP 解，m={m}')
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()

"""
Ref[2] figure[1] ,c


0.010707384343220189, -0.006938656085864858
0.03100482994397702, -0.006938656085864858
0.04492787114119043, -0.006938656085864858
0.054713141058910675, -0.006938656085864858
0.0732771959885285, -0.006938656085864858
0.08720023718574191, -0.006938656085864858
0.09698550710346213, -0.006938656085864858
0.11554956203307995, -0.006938656085864858
0.12947260323029333, -0.006938656085864858
0.1392578731480136, -0.006938656085864858
0.15782192807763148, -0.006938656085864858
0.1717449692748448, -0.006938656085864858
0.18153023919256503, -0.006938656085864858
0.20009429412218296, -0.006938656085864858
0.2140173353193963, -0.006938656085864858
0.2238026052371165, -0.006938656085864858
0.2442118824940759, -0.006938656085864858
0.2584424607458462, -0.006938656085864858
0.26744490907014884, -0.006938656085864858
0.2864842485386274, -0.006938656085864858
0.3007148267903976, -0.006938656085864858
0.3097172751147004, -0.006938656085864858
0.32875661458317884, -0.006938656085864858
0.34298719283494916, -0.006938656085864858
0.3519896411592518, -0.006938656085864858
0.37102898062773026, -0.006938656085864858
0.3852601915478142, -0.009548412879653245
0.39426263987211685, -0.009548412879653245
0.41202353744109277, -0.012158169673441854
0.4263599068730234, -0.016072804864124546
0.43595042039485976, -0.01998744005480746
0.4520564384177137, -0.02930800003262357
0.46560532409329636, -0.04282281200045701
0.4817567451057734, -0.06644111098424332
0.49434462117010636, -0.09455191987733702
0.508781045589487, -0.13638259305777622
0.5222982571778529, -0.19223138844485077
0.534408287903008, -0.2559094542132909
0.5434630684413211, -0.3103228833637819
0.5518917393275066, -0.3653452557661572
0.5599307392548457, -0.42754445935145036
0.5696378219134712, -0.5086643996917108
0.5787582101559093, -0.5915241778944966
0.5879774528223546, -0.6785160710207814
0.5965303692208681, -0.7616803208495093
0.6049460914955677, -0.8440181476935376
0.6134782880068093, -0.9224413393468827
0.6240677004401171, -1.0103901432975566
0.6341487729215292, -1.077311763938277
0.6469944929570884, -1.1310913950102766
0.6646065553052792, -1.1252194422242523
0.6761383061028186, -1.0638901575702215
0.684534025514335, -0.9829876969627769
0.6927288200139092, -0.8805547428065768
0.6974072440262409, -0.8042193565882623
0.7015017679074369, -0.7411502340717062
0.7061780303030302, -0.6558981788079472
0.7102662275010898, -0.5667314883535055
0.714941013670618, -0.47539000057090686
0.7196115293290289, -0.3664326544302354
0.7236985842093, -0.2725539030981201
0.7271994894710982, -0.18266228020095965
0.7318685816258036, -0.06783298127426396
0.734790982011252, -0.013463048070336159
0.7377068448241261, 0.06787437200273971
0.7412071877140899, 0.16008577871660146
0.7458762798687952, 0.27491507764329715
0.7487992074778383, 0.32711021351906777
0.7517155975143072, 0.4062728362639867
0.756387431231705, 0.5097931890842653
0.7622290686610337, 0.6315818394610635
0.7674902856349519, 0.7257505637702666
0.7727532951690921, 0.8125249771637353
0.7774356733583839, 0.8725493834208716
0.7862235944020012, 0.9501896480360805
0.8018769156511448, 0.9630209522722076
0.8114851227968195, 0.886120118748572
0.8179650381988415, 0.7968664364010041
0.8238597670441569, 0.6996529958323812
0.8279911438546229, 0.6107037851107553
0.8315336646321632, 0.5289314055720478
0.8350776616357685, 0.4410695935145006
0.8380275830928603, 0.381915106188627
0.8403909155784841, 0.32058582153459647
0.842758676742303, 0.24098823932404612
0.8457119724304012, 0.16791504909796706
0.8492579096168351, 0.07204998287280162
0.852805238673559, -0.02955654829869858
0.8563538752447977, -0.13655657684402867
0.8598999811427819, -0.2331175782142043
0.8634451591272394, -0.3258509362868236
0.8669912650252236, -0.42241193765699947
0.8717163272367427, -0.5384591230874629
0.8752577232706142, -0.6155919349927688
0.8793896976011542, -0.7070059160196394
0.8841090868867945, -0.7996522821991325
0.8898057905499386, -0.8872966145238639
0.8988279570366833, -0.9686340345969402
0.9133859712678278, -0.9584559831011643
0.9211166719259274, -0.8791193765699932
0.9269649312836055, -0.7846461806348484
0.9304688592940134, -0.7072233957524552
0.9339723655255452, -0.6280607730075363
0.9368911807905498, -0.5589022179721401
0.9403904692333243, -0.46234121660196426
0.9421420114596524, -0.4218899862982419
0.9444717070799338, -0.34446720141584874
0.9485545476862711, -0.23320457010733087
0.9520489645830306, -0.11654844142498333
0.955544457015923, -0.004328899292076249
0.9584584007349124, 0.08492478305549156
0.9619548632592192, 0.19314269810458962
0.9654506509373249, 0.3041443537337285
0.9683640885216631, 0.3954858415163276
0.9707003428034628, 0.44585414763644615
0.9736135905873071, 0.5379785624571813
0.977113806943608, 0.6307119205298006
0.9811997898025699, 0.7290127597625022
0.9847041395918537, 0.8046957067823697
0.9893806655992443, 0.88886036338205
0.9934786164338059, 0.9377933032655851
"""